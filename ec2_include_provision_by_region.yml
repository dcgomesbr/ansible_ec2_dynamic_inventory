---
### provision AWS EC2 instance into a specified region and role configured in an instance type
### ansible-playbook ec2_include_provision_by_region.yml -e "ec2_region=us-east-1 ec2_role=AdminJumpbox ec2_subnets=PrivateSubnetWP01 ec2_sg=AdminSecurityGroup"
### to be included in a loop controling playbook
- name: Reads role variables
  include_vars:
    dir: roles/
    files_matching: "{{ ec2_role }}.yml"

- name: Reads Subnet variables
  include_vars:
    dir: networks/
    files_matching: "{{ ec2_subnet }}.yml"

- name: Reads Security Group variables conditionally, needs ec2_sg parameter
  include_vars:
    dir: networks/
    files_matching: "{{ ec2_sg }}.yml"

- name: Provision "{{ ec2_count }}" instances with role tag "{{ ec2_role }}"
  local_action:
    module: ec2
    key_name: "{{ ec2_keypair }}"
    group_id: "{{ sg_group_id | default(omit) }}"
    instance_type: "{{ ec2_instance_type }}"
    image: "{{ ec2_image }}"
    vpc_subnet_id: "{{ ec2_subnet_id }}"
    region: "{{ ec2_region }}"
    instance_tags: '{"Type":"{{ec2_instance_type}}", "Role":"{{ec2_role}}"}'
    assign_public_ip: "{{ ec2_map_public | default(omit)  }}"
    wait: true
    exact_count: "{{ ec2_count }}"
    count_tag:
      Role: "{{ ec2_role }}"
    volumes:
      - device_name: /dev/xvda
        volume_type: gp2
        volume_size: "{{ ec2_volume_size }}"
        delete_on_termination: true
  register: ec2
